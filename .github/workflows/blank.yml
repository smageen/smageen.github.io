name: Import All Cydia .7z Repos

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0' # ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¾

jobs:
  import-debs:
    runs-on: ubuntu-latest
    steps:

    - name: ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
      run: |
        sudo apt-get update
        sudo apt-get install -y p7zip-full dpkg-dev

    - name: ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸
      run: mkdir -p repo/debs

    - name: ğŸ“¥ Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ²ÑĞµÑ… .7z Ğ¸Ğ· Internet Archive
      run: |
        wget -r -np -nd -A "*.7z" https://archive.org/download/cydia_repository_archive -P repo/archives

    - name: ğŸ“‚ Ğ Ğ°ÑĞ¿Ğ°ĞºĞ¾Ğ²ĞºĞ° Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ¾Ğ² Ñ Ğ»Ğ¾Ğ³Ğ¾Ğ¼
      run: |
        for file in repo/archives/*.7z; do
          echo "ğŸ“‚ Ğ Ğ°ÑĞ¿Ğ°ĞºĞ¾Ğ²ĞºĞ°: $file"
          7z x "$file" -orepo/debs
        done

    - name: ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¿Ğ¾Ğ²Ñ€ĞµĞ¶Ğ´Ñ‘Ğ½Ğ½Ñ‹Ñ… Ğ¸ Ğ½ĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ñ… .deb
      run: |
        echo "ğŸ§¹ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° .deb-Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²..."
        find repo/debs -type f -name "*.deb" | while read file; do
          if ! dpkg-deb -I "$file" >/dev/null 2>&1; then
            echo "âš ï¸ Ğ£Ğ´Ğ°Ğ»Ñ‘Ğ½ Ğ¿Ğ¾Ğ²Ñ€ĞµĞ¶Ğ´Ñ‘Ğ½Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ»: $file"
            rm "$file"
          elif dpkg-deb -I "$file" | grep -E "^Installed-Size:.*$" | uniq -d | grep -q .; then
            echo "âš ï¸ Ğ£Ğ´Ğ°Ğ»Ñ‘Ğ½ Ñ„Ğ°Ğ¹Ğ» Ñ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€ÑƒÑÑ‰Ğ¸Ğ¼ Installed-Size: $file"
            rm "$file"
          fi
        done

    - name: ğŸ§¾ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Packages
      run: |
        echo "ğŸ§¾ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Packages..."
        dpkg-scanpackages repo/debs /dev/null | gzip -9 > repo/Packages.gz

    - name: ğŸš€ ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ½Ğ° GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: repo
