name: Import All Cydia .7z Repos

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0' # еженедельно

jobs:
  import-debs:
    runs-on: ubuntu-latest
    steps:

    - name: 📦 Установка инструментов
      run: |
        sudo apt-get update
        sudo apt-get install -y p7zip-full dpkg-dev

    - name: 📁 Создание папки
      run: mkdir -p repo/debs

    - name: 📥 Скачивание всех .7z из Internet Archive
      run: |
        wget -r -np -nd -A "*.7z" https://archive.org/download/cydia_repository_archive -P repo/archives

    - name: 📂 Распаковка архивов с логом
      run: |
        for file in repo/archives/*.7z; do
          echo "📂 Распаковка: $file"
          7z x "$file" -orepo/debs
        done

    - name: 🧹 Очистка повреждённых и некорректных .deb
      run: |
        echo "🧹 Проверка .deb-файлов..."
        find repo/debs -type f -name "*.deb" | while read file; do
          if ! dpkg-deb -I "$file" >/dev/null 2>&1; then
            echo "⚠️ Удалён повреждённый файл: $file"
            rm "$file"
          elif dpkg-deb -I "$file" | grep -E "^Installed-Size:.*$" | uniq -d | grep -q .; then
            echo "⚠️ Удалён файл с дублирующим Installed-Size: $file"
            rm "$file"
          fi
        done

    - name: 🧾 Генерация Packages
      run: |
        echo "🧾 Генерация Packages..."
        dpkg-scanpackages repo/debs /dev/null | gzip -9 > repo/Packages.gz

    - name: 🚀 Публикация на GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: repo
