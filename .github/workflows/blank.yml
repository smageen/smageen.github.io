name: Import All Cydia .7z Repos

on:
  workflow_dispatch:

jobs:
  import-debs:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # â±ï¸ Ð·Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ð°

    steps:
    - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²
      run: |
        sudo apt-get update
        sudo apt-get install -y dpkg-dev p7zip-full wget

    - name: ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð°Ð¿ÐºÐ¸
      run: mkdir -p repo/debs

    - name: ðŸ“¥ Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð²ÑÐµÑ… .7z Ð¸Ð· Internet Archive
      run: |
        echo "ðŸ“¥ Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ .7z-Ð°Ñ€Ñ…Ð¸Ð²Ð¾Ð²..."
        urls=(
          "https://archive.org/download/cydia_repository_archive/apptapp.saurik.com.7z"
          "https://archive.org/download/cydia_repository_archive/apt.saurik.com-(ios_main_).7z"
          "https://archive.org/download/cydia_repository_archive/apt.thebigboss.org_repofiles_cydia-(_stable_main_).7z"
          "https://archive.org/download/cydia_repository_archive/artillect.github.io_repo.7z"
          "https://archive.org/download/cydia_repository_archive/cydia.bag-xml.com.7z"
          "https://archive.org/download/cydia_repository_archive/cydia.invoxiplaygames.uk.7z"
          "https://archive.org/download/cydia_repository_archive/cydia.invoxiplaygames.uk_beta.7z"
          "https://archive.org/download/cydia_repository_archive/evynw.github.io.7z"
          "https://archive.org/download/cydia_repository_archive/havoc.app.7z"
          "https://archive.org/download/cydia_repository_archive/ios3.party.7z"
          "https://archive.org/download/cydia_repository_archive/pwnage.dev.7z"
          "https://archive.org/download/cydia_repository_archive/repo.dynastic.co.7z"
          "https://archive.org/download/cydia_repository_archive/repo.mtmdev.org.7z"
        )

        for url in "${urls[@]}"; do
          filename=$(basename "$url")
          echo "â¬‡ï¸ Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ $filename..."
          wget --tries=5 --timeout=60 --progress=bar:force -O "repo/$filename" "$url"
        done

    - name: ðŸ“‚ Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²ÐºÐ° Ð°Ñ€Ñ…Ð¸Ð²Ð¾Ð² Ñ Ð»Ð¾Ð³Ð¾Ð¼
      run: |
        echo "ðŸ“‚ Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²ÐºÐ° .7z..."
        for file in repo/*.7z; do
          echo "ðŸ“‚ Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²ÐºÐ° $(basename "$file")..."
          7z x "$file" -orepo/debs | tee -a unpack.log
        done

    - name: ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´Ñ‘Ð½Ð½Ñ‹Ñ… .deb
      run: |
        echo "ðŸ§¹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° .deb-Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
        find repo/debs -type f -name "*.deb" | while read file; do
          if ! dpkg-deb -I "$file" >/dev/null 2>&1; then
            echo "âš ï¸ Ð£Ð´Ð°Ð»Ñ‘Ð½ Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´Ñ‘Ð½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»: $file"
            rm "$file"
          fi
        done

    - name: ðŸ§¾ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Packages
      run: |
        echo "ðŸ§¾ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Packages..."
        cd repo
        dpkg-scanpackages debs/ /dev/null > Packages
        gzip -9 < Packages > Packages.gz

